---
title: "Serology Testing Sample Size Estimation"
author: "CS472"
date: "4/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggrepel)
library(viridis)
require(cowplot)

```

## Serology Testing Exploration

### Questions:
1. Q1: How large does sample size need to be to detect prevalence levels using a perfect test?
2. Q2: How large does sample size need to be to detect prevalence levels using an imperfect test?
3. Q3: For a set prevalence, how does sensitivity and specificity affect needed sample size?


### Resources
1. Humphry 2004 https://www.sciencedirect.com/science/article/pii/S0167587704001412
2. Arya 2012 https://link.springer.com/article/10.1007/s12098-012-0763-3


### Q1: How large does sample size need to be to detect prevalence levels using a perfect test?

```{r q1}

# Set up data

# Dummy frame for reported prevalence values
reported_prev <- data.frame(
  area = c("NY State", "NYC Shoppers", "LA Study", "Santa Clara Study"),
  prev = c(0.139, 0.212, 0.208, 0.242)
)

# Z score for 95% CI
z = 1.96

# PREVALENCE RANGE 
# based on reported prevalences
min_prev = min(reported_prev$prev - 0.1)
max_prev = max(reported_prev$prev + 0.1)

# TOLERANCE LEVEL (ALLOWABLE ERROR)
# Conventionally, an ‘absolute’ allowable error margin d of ±5 % is chosen, 
# but, as is common in clinical practice, 
# if expected prevalence P is <10 %, 
# the 95 % confidence boundaries may cross 0, which is impractical.
# A common recommendation is to set d = P/2 for rare 
# and d = (1-P)/2 for very common conditions


# Data frame of prevalence, tolerance, and min n
# Use simple formula for perfect etst
# min_n_perfect: 95% chance of estimating true prevalence at min sample size

result_df <- data.frame(prevalence = seq(min_prev, max_prev, by = .01)) %>%
  mutate(tolerance = ifelse(prevalence < 0.1 | prevalence > 0.0,
                            prevalence/2,
                            0.05),
         min_n_perfect = ((z/tolerance)^2) * prevalence * (1 - prevalence))

# Plot estimates of prevalence vs min n
plot_perfect <- ggplot(data = result_df, 
       aes(x = prevalence, y = min_n_perfect)) +
    geom_errorbarh(aes(xmin = prevalence - tolerance/2, 
                     xmax = prevalence + tolerance/2),
                 color = "darkgray") +
  geom_point() +
  geom_line() +

  theme_bw() +
  geom_vline(xintercept = reported_prev$prev, 
             linetype = "dashed", 
             color = "red") +
  geom_text_repel(data = reported_prev,
                    aes(y = max(result_df$min_n_perfect),
                        x = prev,
                        label = area),
                    box.padding = 0.2,
                    arrow = arrow(ends = "last", length = unit(0.1, "cm"))
                   ) +
  ggtitle("Sample size needed to estimate population prevalence\nwith 95% confidence of being within tolerance using a perfect test")

plot_perfect

```

### Q2: How large does sample size need to be to detect prevalence levels using an imperfect test?

```{r q2}

# Imperfect test - with sensitivity and specificity
# Rogan and Gladen 1978
# Assume normal approximation to binomial distribution

# Vary sensitivity and specificity
# For now hardcode values around Marson paper estimates
sens = 0.8
spec = 0.8

imp_result_df <- result_df %>%
 mutate(sens = sens,
        spec = spec,
        min_n_imperfect = (z/tolerance)^2 * 
          ((sens * prevalence) + (1 - spec)*(1 - prevalence)) * 
          (1 - (sens * prevalence) - (1 - spec)* (1 - prevalence)) / 
          (sens + spec - 1)^2
 )

plot_imperfect <- ggplot(data = imp_result_df, 
       aes(x = prevalence, y = min_n_imperfect)) +
    geom_errorbarh(aes(xmin = prevalence - tolerance/2, 
                     xmax = prevalence + tolerance/2),
                 color = "darkgray") +
  geom_point() +
  geom_line() +
  theme_bw() +
  geom_vline(xintercept = reported_prev$prev, 
             linetype = "dashed", 
             color = "red") +
  geom_text_repel(data = reported_prev,
                    aes(y = max(imp_result_df$min_n_imperfect),
                        x = prev,
                        label = area),
                    box.padding = 0.2,
                    arrow = arrow(ends = "last", length = unit(0.1, "cm"))
                   ) +
  ggtitle(paste0("Sample size needed to estimate population prevalence\nwith 95% confidence of being within tolerance\nusing an imperfect test: Sensitivity = ", sens, " Specificity = ", spec))

plot_imperfect


```




### Q3: For a set prevalence, how does sensitivity and specificity affect needed sample size?

```{r q3}

# Use same formula for imperfect test as in Q2
# Set prevalence to 0.1 

# Reported sensitivity and specificity of tests
# Fill in with real data
reported_ss <- data.frame(
  test = c("test1", "test2", "test3"),
  sens = c(0.8,0.9,1),
  spec = c(0.8,0.9,1)
)

set_prev = 0.1
# Now vary sensitivity and specificity

q3_result_df <- data.frame(
  sens = seq(0.7,1, by = 0.05),
  spec = seq(0.7,1, by = 0.05)) %>%
  complete(sens, spec) %>%
 mutate(
   prevalence = set_prev,
   tolerance = ifelse(prevalence < 0.1 | prevalence > 0.0,
                            prevalence/2,
                            0.05),
   min_n = (z/tolerance)^2 * 
          ((sens * prevalence) + (1 - spec)*(1 - prevalence)) * 
          (1 - (sens * prevalence) - (1 - spec)* (1 - prevalence)) / 
          (sens + spec - 1)^2
 )

plot_q3 <- ggplot(data = q3_result_df, 
       aes(x = sens, y = spec)) +
  geom_tile(aes(fill = min_n, label = min_n)) +
  geom_text(aes(label = round(min_n, digits = 0))) +
  ggtitle(paste0("Sample size needed to detect prevalence of ", 
                 set_prev, " with varying test S&S")) +
  scale_fill_viridis(discrete = F)

plot_q3


```


